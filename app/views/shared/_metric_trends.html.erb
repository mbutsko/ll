<div class="min-h-screen bg-gray-50">
  <nav class="bg-white border-b border-gray-200">
    <div class="max-w-5xl mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <%= link_to "&larr;".html_safe, root_path, class: "text-lg text-gray-400 hover:text-gray-600 transition no-underline" %>
        <span class="text-lg font-semibold text-gray-900"><%= title %></span>
      </div>
      <div class="relative" data-controller="metric-search">
        <div class="relative">
          <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
          </svg>
          <input type="text"
                 placeholder="Search metricsâ€¦"
                 autocomplete="off"
                 data-metric-search-target="input"
                 data-action="input->metric-search#onInput keydown->metric-search#onKeydown blur->metric-search#onBlur"
                 class="w-56 pl-8 pr-10 py-1.5 text-sm bg-gray-100 border border-gray-200 rounded-lg focus:outline-none focus:bg-white focus:border-blue-300 focus:ring-2 focus:ring-blue-500/20 placeholder-gray-400 transition-all">
          <kbd class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-[10px] font-medium text-gray-400 bg-gray-200/70 px-1.5 py-0.5 rounded" data-metric-search-target="shortcutHint">/</kbd>
        </div>
        <div data-metric-search-target="results"
             class="hidden absolute right-0 z-50 mt-1.5 w-72 bg-white border border-gray-200 rounded-xl shadow-xl shadow-gray-200/50 max-h-64 overflow-y-auto overflow-x-hidden"></div>
      </div>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-6 py-10">
    <% if local_assigns.fetch(:daily, false) %>
      <%# Trend indicator cards %>
      <div class="flex gap-4 mb-8">
        <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 p-5">
          <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">7-Day Average</p>
          <% if @trends[:avg_7d] %>
            <p class="mt-1 text-2xl font-bold text-gray-900"><%= @trends[:avg_7d] %> <span class="text-sm font-normal text-gray-400"><%= unit %></span></p>
            <% if @trends[:delta_7d] %>
              <p class="mt-1 text-sm font-medium <%= @trends[:delta_7d] <= 0 ? delta_down_class : delta_up_class %>">
                <%= @trends[:delta_7d] > 0 ? '+' : '' %><%= @trends[:delta_7d] %> <%= unit %> vs prior 7d
              </p>
            <% end %>
          <% else %>
            <p class="mt-1 text-sm text-gray-400">Not enough data</p>
          <% end %>
        </div>

        <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 p-5">
          <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">30-Day Average</p>
          <% if @trends[:avg_30d] %>
            <p class="mt-1 text-2xl font-bold text-gray-900"><%= @trends[:avg_30d] %> <span class="text-sm font-normal text-gray-400"><%= unit %></span></p>
            <% if @trends[:delta_30d] %>
              <p class="mt-1 text-sm font-medium <%= @trends[:delta_30d] <= 0 ? delta_down_class : delta_up_class %>">
                <%= @trends[:delta_30d] > 0 ? '+' : '' %><%= @trends[:delta_30d] %> <%= unit %> vs prior 30d
              </p>
            <% end %>
          <% else %>
            <p class="mt-1 text-sm text-gray-400">Not enough data</p>
          <% end %>
        </div>
      </div>
    <% end %>

    <div data-controller="metric-chart"
         data-metric-chart-data-value="<%= @chart_data.to_json %>"
         data-metric-chart-range-value="<%= @range %>"
         data-metric-chart-unit-value="<%= unit %>"
         data-metric-chart-label-value="<%= label %>"
         data-metric-chart-fetch-url-value="<%= fetch_url %>"
         data-metric-chart-daily-value="<%= local_assigns.fetch(:daily, false) %>">

      <%# Date range filter buttons %>
      <div class="flex gap-2 mb-6">
        <% %w[30d 90d 1y all].each do |range| %>
          <button data-action="click->metric-chart#changeRange"
                  data-range="<%= range %>"
                  class="px-4 py-2 text-sm font-medium rounded-lg transition
                         <%= range == @range ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border border-gray-300 hover:bg-gray-50' %>">
            <%= range == 'all' ? 'ALL' : range.upcase %>
          </button>
        <% end %>
      </div>

      <%# Chart %>
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5" style="position: relative; height: 400px;">
        <canvas data-metric-chart-target="canvas"></canvas>
      </div>
    </div>
  </main>
</div>
