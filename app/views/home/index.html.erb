<div class="min-h-screen bg-gray-50">
  <nav class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <span class="text-lg font-semibold text-gray-900">Daily Log</span>
      <div class="relative" data-controller="dropdown">
        <button data-action="click->dropdown#toggle" class="p-1.5 rounded-lg hover:bg-gray-100 transition cursor-pointer">
          <svg class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        </button>
        <div data-dropdown-target="menu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-200 py-1 z-20">
          <%= link_to "Add Measurement", new_measurement_path,
                class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition" %>
          <%= link_to "Manage Metrics", metrics_path,
                class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition" %>
          <%= link_to "Manage Exercises", exercises_path,
                class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition" %>
          <%= link_to "Manage Foods", foods_path,
                class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition" %>
          <%= link_to "Manage Labels", labels_path,
                class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition" %>
          <div class="border-t border-gray-100 my-1"></div>
          <div class="px-4 py-2">
            <details class="group">
              <summary class="text-sm text-gray-700 cursor-pointer list-none hover:text-gray-900 transition">
                <span class="group-open:hidden">API Token</span>
                <span class="hidden group-open:inline">Hide Token</span>
              </summary>
              <div class="mt-2 flex items-center justify-between gap-2">
                <code class="text-xs bg-gray-100 px-2 py-1 rounded font-mono text-gray-800 break-all select-all"><%= current_user.api_token %></code>
                <%= button_to "Regenerate", regenerate_api_token_path,
                      class: "shrink-0 text-xs text-red-600 hover:text-red-800 font-medium transition cursor-pointer",
                      data: { turbo_confirm: "This will invalidate your current token. Continue?" } %>
              </div>
            </details>
          </div>
          <div class="border-t border-gray-100 my-1"></div>
          <%= button_to "Sign out", destroy_user_session_path, method: :delete,
                class: "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition cursor-pointer" %>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-6 py-6">

    <%
      metrics = @metrics.map do |m|
        measurement = @todays_measurements[m.id]
        {
          metric: m,
          entry: measurement,
          name: m.slug == "steps" ? "Steps Yesterday" : m.name,
          unit: m.units,
          step: m.slug == "weight" ? 0.1 : 1,
          min: m.slug == "steps" ? 0 : (m.slug == "weight" ? 0.1 : 1),
          placeholder: m.units || m.slug
        }
      end
      pending  = metrics.reject { |m| m[:entry] }
      recorded = metrics.select { |m| m[:entry] }
    %>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <%# Left column: logging (2/3 width) %>
      <div class="md:col-span-2 space-y-3">
        <% if pending.any? %>
          <div class="space-y-2">
            <% pending.each do |m| %>
              <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
                <%= form_with url: measurements_path(metric_slug: m[:metric].slug), method: :post, class: "flex items-end gap-3" do |f| %>
                  <div class="flex-1">
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1"><%= m[:name] %></p>
                    <%= f.number_field "measurement[value]", step: m[:step], min: m[:min], required: true, placeholder: m[:placeholder],
                          class: "w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" %>
                  </div>
                  <%= f.submit "Save", class: "bg-blue-600 text-white font-medium px-5 py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition cursor-pointer" %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>

        <div data-controller="food-log">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
            <%= form_with url: food_logs_path, method: :post, class: "flex items-end gap-3" do |f| %>
              <input type="hidden" name="food_log[food_id]" data-food-log-target="foodId">
              <div class="flex-1 relative">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Food</p>
                <span data-food-log-target="selectedName" data-action="click->food-log#clearSelection"
                      class="hidden inline-flex items-center gap-1 bg-blue-50 text-blue-700 text-sm font-medium px-3 py-2 rounded-lg cursor-pointer hover:bg-blue-100 transition">
                </span>
                <input type="text" placeholder="Search foods..."
                       data-food-log-target="input"
                       data-action="input->food-log#onInput keydown->food-log#onKeydown blur->food-log#onBlur"
                       autocomplete="off"
                       class="w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition">
                <div data-food-log-target="results" class="hidden absolute z-10 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-48 overflow-y-auto py-1"></div>
              </div>
              <div class="w-28">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Amount</p>
                <%= f.number_field "food_log[value]", step: "any", min: 0, required: true, placeholder: "0",
                      data: { food_log_target: "value" },
                      class: "w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" %>
              </div>
              <div class="w-36">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Unit</p>
                <%= f.select "food_log[unit]", Food::UNITS.map { |u| [u.capitalize, u] },
                      {}, data: { food_log_target: "unitSelect" },
                      class: "w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" %>
              </div>
              <%= f.submit "Save", class: "bg-blue-600 text-white font-medium px-5 py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition cursor-pointer" %>
            <% end %>
          </div>

        </div>

        <div data-controller="exercise-log" data-exercise-log-last-values-value="<%= @last_exercise_values.to_json %>" data-exercise-log-last-weights-value="<%= @last_exercise_weights.to_json %>">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
            <%= form_with url: exercise_logs_path, method: :post, class: "flex items-end gap-3" do |f| %>
              <input type="hidden" name="exercise_log[exercise_id]" data-exercise-log-target="exerciseId">
              <div class="flex-1 relative">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Exercise</p>
                <span data-exercise-log-target="selectedName" data-action="click->exercise-log#clearSelection"
                      class="hidden inline-flex items-center gap-1 bg-blue-50 text-blue-700 text-sm font-medium px-3 py-2 rounded-lg cursor-pointer hover:bg-blue-100 transition">
                </span>
                <input type="text" placeholder="Search exercises..."
                       data-exercise-log-target="input"
                       data-action="input->exercise-log#onInput keydown->exercise-log#onKeydown blur->exercise-log#onBlur"
                       autocomplete="off"
                       class="w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition">
                <div data-exercise-log-target="results" class="hidden absolute z-10 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-48 overflow-y-auto py-1"></div>
              </div>
              <div class="w-28">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
                  <span data-exercise-log-target="unitLabel"></span>
                </p>
                <%= f.number_field "exercise_log[value]", step: 1, min: 0, required: true, placeholder: "0",
                      data: { exercise_log_target: "value" },
                      class: "w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" %>
              </div>
              <div class="w-24 hidden" data-exercise-log-target="weightField">
                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Lbs</p>
                <%= f.number_field "exercise_log[weight_lbs]", step: "any", min: 0, placeholder: "0",
                      data: { exercise_log_target: "weightInput" },
                      class: "w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" %>
              </div>
              <%= f.submit "Save", class: "bg-blue-600 text-white font-medium px-5 py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition cursor-pointer" %>
            <% end %>
          </div>

        </div>

        <div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
            <%= form_with url: journal_entries_path, method: :post, class: "space-y-2" do |f| %>
              <textarea name="journal_entry[body]" rows="2" required placeholder="Write something..."
                    class="w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition resize-y"></textarea>
              <% if @labels.any? %>
                <div class="flex flex-wrap gap-2">
                  <% @labels.each do |label| %>
                    <label class="inline-flex items-center gap-1.5 cursor-pointer">
                      <input type="checkbox" name="journal_entry[label_ids][]" value="<%= label.id %>"
                        class="h-3.5 w-3.5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                      <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium <%= label_color_classes(label.color) %>"><%= label.name %></span>
                    </label>
                  <% end %>
                </div>
              <% end %>
              <div>
                <%= f.submit "Save", class: "bg-blue-600 text-white font-medium px-5 py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition cursor-pointer" %>
              </div>
            <% end %>
          </div>

        </div>
      </div>

      <%# Right column: today's recorded stream (1/3 width) %>
      <div>
        <div class="space-y-3">
          <%
            metrics_by_slug = metrics.index_by { |m| m[:metric].slug }
            grid_slots = [["weight", "steps"], ["hrv", "rhr"]]
          %>
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
            <div class="grid grid-cols-2 gap-3">
              <% grid_slots.flatten.each do |slug| %>
                <% m = metrics_by_slug[slug] %>
                <% if m && m[:entry] %>
                  <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide"><%= m[:name] %></p>
                    <% display_val = m[:entry].value % 1 == 0 ? number_with_delimiter(m[:entry].value.to_i) : number_with_delimiter(m[:entry].value) %>
                    <p class="text-lg font-bold text-gray-900">
                      <%= display_val %>
                      <% if m[:unit] %>
                        <span class="text-xs font-normal text-gray-400"><%= m[:unit] %></span>
                      <% end %>
                    </p>
                    <div class="flex items-center gap-2">
                      <%= link_to "Trends", measurement_path(metric_slug: m[:metric].slug),
                            class: "text-xs font-medium text-blue-600 hover:text-blue-800 transition" %>
                      <%= link_to "Edit", edit_measurement_path(m[:entry]),
                            class: "text-xs font-medium text-gray-400 hover:text-gray-600 transition" %>
                    </div>
                  </div>
                <% elsif m %>
                  <div class="text-xs text-gray-300 uppercase tracking-wide pt-1"><%= m[:name] %></div>
                <% end %>
              <% end %>
            </div>
          </div>

          <%
            food_clusters = @todays_food_logs.slice_when { |a, b| (a.consumed_at - b.consumed_at).abs > 30.minutes }.to_a
            food_clusters.each do |cluster|
          %>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
              <div class="flex items-center justify-between mb-1">
                <p class="text-xs font-medium text-orange-600 uppercase tracking-wide">Food</p>
                <span class="text-xs text-gray-400"><%= cluster.first.consumed_at.strftime("%-I:%M %p") %></span>
              </div>
              <div class="<%= 'divide-y divide-gray-100' if cluster.size > 1 %>">
                <% cluster.each do |log| %>
                  <div class="<%= 'py-1.5' if cluster.size > 1 %> flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-gray-900"><%= log.food.name %></p>
                      <% food_val = log.value % 1 == 0 ? number_with_delimiter(log.value.to_i) : number_with_delimiter(log.value) %>
                      <p class="text-xs text-gray-500"><%= food_val %> <%= log.unit %></p>
                    </div>
                    <%= button_to "Delete", food_log_path(log), method: :delete,
                          class: "text-xs text-gray-400 hover:text-red-600 transition cursor-pointer",
                          data: { turbo_confirm: "Delete this food entry?" } %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <%
            exercise_clusters = @todays_exercise_logs.slice_when { |a, b| (a.performed_at - b.performed_at).abs > 30.minutes }.to_a
            exercise_clusters.each do |cluster|
          %>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
              <div class="flex items-center justify-between mb-1">
                <p class="text-xs font-medium text-blue-600 uppercase tracking-wide">Exercise</p>
                <span class="text-xs text-gray-400"><%= cluster.first.performed_at.strftime("%-I:%M %p") %></span>
              </div>
              <div class="<%= 'divide-y divide-gray-100' if cluster.size > 1 %>">
                <% cluster.each do |log| %>
                  <div class="<%= 'py-1.5' if cluster.size > 1 %> flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-gray-900"><%= log.exercise.name %></p>
                      <% ex_val = log.value % 1 == 0 ? number_with_delimiter(log.value.to_i) : number_with_delimiter(log.value) %>
                      <p class="text-xs text-gray-500">
                        <%= ex_val %> <%= log.exercise.unit_label %>
                        <% if log.weight_lbs.present? && log.weight_lbs > 0 %>
                          @ <%= log.weight_lbs % 1 == 0 ? log.weight_lbs.to_i : log.weight_lbs %> lbs
                        <% end %>
                      </p>
                    </div>
                    <%= button_to "Delete", exercise_log_path(log), method: :delete,
                          class: "text-xs text-gray-400 hover:text-red-600 transition cursor-pointer",
                          data: { turbo_confirm: "Delete this exercise entry?" } %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @todays_journal_entries.any? %>
            <% @todays_journal_entries.each do |entry| %>
              <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3">
                <div class="flex items-start justify-between">
                  <p class="text-xs font-medium text-purple-600 uppercase tracking-wide">Journal</p>
                  <span class="text-xs text-gray-400"><%= entry.recorded_at.strftime("%-I:%M %p") %></span>
                </div>
                <p class="text-sm text-gray-900 mt-1 whitespace-pre-wrap"><%= entry.body %></p>
                <% if entry.labels.any? %>
                  <div class="mt-1.5 flex items-center gap-1.5 flex-wrap">
                    <% entry.labels.each do |label| %>
                      <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium <%= label_color_classes(label.color) %>"><%= label.name %></span>
                    <% end %>
                  </div>
                <% end %>
                <%= button_to "Delete", journal_entry_path(entry), method: :delete,
                      class: "mt-1 text-xs text-gray-400 hover:text-red-600 transition cursor-pointer",
                      data: { turbo_confirm: "Delete this journal entry?" } %>
              </div>
            <% end %>
          <% end %>

          <% if recorded.empty? && @todays_food_logs.empty? && @todays_exercise_logs.empty? && @todays_journal_entries.empty? %>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 text-center text-gray-400">
              Nothing recorded yet
            </div>
          <% end %>
        </div>
      </div>
    </div>

  </main>
</div>
